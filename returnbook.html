<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>returnbook</title>
   
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <style>
    
    .form-control{
        width: 200px;
    }
    
    .btn{
    color: greenyellow !important; 
    background-color: #f0a;  
  padding: 20px;             
  border-radius: 20px;       
  width:fit-content;           /* Width fit to content */
  box-shadow: 0 4px 8px #ccc;
  font-size: xx-large;
}
.head-shape h1 {
  background-color: #f0a; 
  color:greenyellow;              
  padding: 10px;                
  border-radius: 20px;   
  width:fit-content;          
  box-shadow: 0 4px 8px #ccc;
}
 </style>
</head>
<body>
   <div class="container-fluid">
        <div class="row">
            <div class="col-md">
<div class="bg" style="background-image: url('bookissue.jpg'); background-size: cover; background-position: center;min-height: 100vh;">
   <nav class="navbar navbar-expand-lg bg-wheat navbar-dark px-4">
  <div class="container-fluid justify-content-end">
    <a class="nav-link text-white fw-bold" href="dash.html">
      <i class="fa fa-home me-1"></i>Dashboard
    </a>
  </div>
</nav>
  <!--heading-->
    <div class=" head-shape d-flex flex-column align-items-center py-3 text-white">
        <h1 class="display-5">Return Book</h1>
    </div>
<!--Form-->
<form class="was-validated text-white px-3">
  <!--1 row--> 
<div class="row">
  <div class=" col-md-4 d-flex flex-column  justify-content-center align-items-center py-3">
    <label for="studentId" class="me-2 fw-bold" style="font-size:x-large; color:greenyellow;">Student ID</label>
    <input type="number" id="studentId"  class="form-control-lg" style="font-size: large; font-weight: 500;" placeholder="ID" required>
  </div>
 
  <div class="col-md-4 d-flex flex-column justify-content-center align-items-center py-3">
    <label for="bookSelector" class="me-2 fw-bold" style="font-size:x-large; color:greenyellow;">Select Book</label>
    <select id="bookSelector" class="form-control-lg" style="font-size: large; font-weight: 500;" required>
    <option value="">Books issues</option>
    </select>
</div>

<div class=" col-md-4 d-flex flex-column  justify-content-center align-items-center py-3">
        <label for="bookId" class="me-2 fw-bold" style="font-size:x-large; color:greenyellow;">Book ID</label>
        <input type="number" id="bookId"  class="form-control-lg" style="font-size: large; font-weight: 500;" placeholder=" Issued Book Number" readonly>
    </div>
    </div><!--end 1 row-->

<div class="row">
     <div class="col-md-6 d-flex flex-column justify-content-center align-items-center py-3">
       <label for="studentname" class="me-2 fw-bold" style="font-size:x-large;color:greenyellow;">Student Name:</label>
        <input type="text" id="studentname" name="studentname" class="form-control-lg" style="font-size: large; font-weight: 500;" placeholder="Name" readonly> 
    </div><!--end col-->
    <div class="col-md-6 d-flex flex-column justify-content-center align-items-center py-3">
       <label for="bookTitle" class="me-2 fw-bold" style="font-size:x-large;color:greenyellow;">Book Name:</label>
        <input type="text" id="bookTitle" name="bookTitle" class="form-control-lg" style="font-size: large; font-weight: 500;" placeholder="Issued book name" readonly> 
    </div><!--end col-->
     </div><!--end 2 row-->

    <div class="row">
    <div class="col-md-6 d-flex flex-column justify-content-center align-items-center py-3">
       <label for="currentDate" class="me-2 fw-bold" style="font-size:x-large;color:greenyellow;">Issue Date:</label>
        <input type="date" id="currentDate" name="currentDate" class="form-control-lg" style="font-size: large; font-weight: 500;" placeholder="Date of issue" readonly> 
    </div><!--end col-->

<div class="col-md-6 d-flex flex-column justify-content-center align-items-center py-3">
       <label for="returnDate" class="me-2 fw-bold" style="font-size:x-large;color:greenyellow;"> Return Date:</label>
        <input type="date" id="returnDate" name="returnDate" class="form-control-lg" style="font-size: large; font-weight: 500;" placeholder="Date of return" readonly> 
    </div><!--end col-->
</div><!--end 3 row-->

    <div class="row">
    <div class="col-md-6 d-flex flex-column justify-content-center align-items-center py-3">
        <label for="dueDate" class="me-2 fw-bold" style="font-size:x-large;color:greenyellow;"> Due Date:</label>
        <input type="date" id="dueDate" name="dueDate" class="form-control-lg" style="font-size: large; font-weight: 500;" placeholder="15days after issue" readonly>
    </div>
        <div class="col-md-6 d-flex flex-column justify-content-center align-items-center py-3">
       <label for="fine" class="me-2 fw-bold" style="font-size:x-large;color:greenyellow;"> Fine:</label>
      <input type="number" id="fine" name="fine" class="form-control-lg" style="font-size: large; font-weight: 500;" placeholder="rs 10/day form issue" readonly> 
 </div><!--end col-->
    
</div><!--end 4 row-->
<!--button row-->
<div class="row">
   <div class="col-md d-flex  justify-content-center">
  <button type="submit" class="btn">Return Book</button>
  <button type="button" class="btn" onclick="IssuedTable()">View Record</button>
  <button type="button" class="btn" onclick="deleteRecord()">Delete Record</button>
  <button type="button" class="btn" onclick="calculateFine()">Calculate Fine</button>
<!--<button type="button" class="btn" onclick="clearAllRecords()">Clear All Records</button>-->
</div>
</div><!--endrow--> 
</form>
<!--table-->
<div class="container-fluid mt-4" id="returnTableContainer" style="display: none;">
<h2 class="text-white text-center">Return Book Records</h2>
  <div class="table-responsive">
    <table class="table table-bordered text-white">
      <thead>
        <tr>
          <th>Student ID</th>
          <th>Book ID</th>
          <th>Student Name</th>
          <th>Book Name</th>
           <th>Issue Date</th>
          <th>Return Date</th>
        <th>Due Date</th>
          <th>Fine</th>
        </tr>
      </thead>
      <tbody id="returnTableBody">
      </tbody>
    </table>
  </div></div>
   <div id="result"></div>
</div><!--end bg--></div><!--end col--></div><!--end row-->
</div><!--endcontainer-->

<script>
  function formatDate(date){ 
    return date.toISOString().split('T')[0];
}
window.onload = function(){
const today=new Date();
    document.getElementById('currentDate').value=formatDate(today);
    document.getElementById('returnDate').value=formatDate(today);
    let dueDate=new Date(today);
    dueDate.setDate(dueDate.getDate() + 15);
    document.getElementById('dueDate').value = formatDate(dueDate);
  };

//accessing
  document.getElementById("studentId").addEventListener("change", function () {
    const studentId = this.value;
    const issueHistory = JSON.parse(localStorage.getItem("issueHistory")) || [];
    const bookSelector = document.getElementById("bookSelector");

    const studentRecords = issueHistory.filter(item => item.studentId.toString() === studentId);

    bookSelector.innerHTML = `<option value="">book issued</option>`; 

    if (studentRecords.length > 0) {
      studentRecords.forEach(record => {
        const option = document.createElement("option");
        option.value = record.bookId;
        option.textContent = `${record.bookTitle} (Book ID: ${record.bookId})`;
        bookSelector.appendChild(option);
      });
    } else {
      alert("No issue record found for this student ID.");
      clearForm();
    }
  });
// NO OF BOOKS ACCESsed
  document.getElementById("bookSelector").addEventListener("change", function () {
    const studentId = document.getElementById("studentId").value;
    const bookId = this.value;
    const issueHistory = JSON.parse(localStorage.getItem("issueHistory")) || [];
    const record = issueHistory.find(item =>item.studentId.toString() === studentId && item.bookId.toString() === bookId );

    if (record) {
      document.getElementById("bookId").value = record.bookId;
      document.getElementById("studentname").value = record.studentname;
      document.getElementById("bookTitle").value = record.bookTitle;
      document.getElementById("currentDate").value = record.issueDate;

      const today = new Date();
      document.getElementById("returnDate").value = formatDate(today);

      let due = new Date(record.issueDate);
      due.setDate(due.getDate() + 15);
      document.getElementById("dueDate").value = formatDate(due);

      document.getElementById("fine").value = '';
      document.getElementById("result").innerHTML = '';
      calculateFine();
    } else {
      clearForm();
    }
  });

  function clearForm() {
    document.getElementById("bookId").value = '';
    document.getElementById("studentname").value = '';
    document.getElementById("bookTitle").value = '';
    document.getElementById("currentDate").value = '';
    document.getElementById("returnDate").value = '';
    document.getElementById("dueDate").value = '';
    document.getElementById("fine").value = '';
    document.getElementById("result").innerHTML = '';
    document.getElementById("bookSelector").innerHTML = `<option value="">-- Book issued --</option>`;
  }

 
  function calculateFine() {
    const due = new Date(document.getElementById("dueDate").value);
    const ret = new Date(document.getElementById("returnDate").value);
    const resultDiv = document.getElementById("result");

    if (!due || !ret || isNaN(due) || isNaN(ret)) {
      resultDiv.innerHTML = `<div class="alert alert-warning">Please select both dates.</div>`;
      return;
    }

    const diffTime = ret - due;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays > 0) {
      const fineAmount = diffDays * 10;
      document.getElementById("fine").value = fineAmount;
      resultDiv.innerHTML = `<div class="alert alert-danger">Fine is ₹${fineAmount} for ${diffDays} days late.</div>`;
    } else {
      document.getElementById("fine").value = 0;
      resultDiv.innerHTML = `<div class="alert alert-success">No fine. Book returned on time.</div>`;
    }
  }

  document.querySelector('form').addEventListener('submit', function (e) {
    e.preventDefault();

    if (document.getElementById('fine').value === '') {
      alert("Please calculate the fine before returning the book.");
      return;
    }

    const studentId = document.getElementById('studentId').value;
    const bookId = document.getElementById('bookId').value;
    const studentName = document.getElementById('studentname').value;
    const bookTitle = document.getElementById('bookTitle').value;
    const issueDate = document.getElementById('currentDate').value;
    const returnDate = document.getElementById('returnDate').value;
    const dueDate = document.getElementById('dueDate').value;
    const fine = document.getElementById('fine').value;

    const transaction = {
      studentId,
      bookId,
      studentName,
      bookTitle,
      issueDate,
      returnDate,
      dueDate,
      fine
    };

 
    let returnHistory = JSON.parse(localStorage.getItem('returnHistory')) || [];
    returnHistory.push(transaction);
    localStorage.setItem('returnHistory', JSON.stringify(returnHistory));

   // remove record
    let issueHistory = JSON.parse(localStorage.getItem('issueHistory')) || [];
    const updatedIssueHistory = issueHistory.filter(
      entry => !(entry.studentId === studentId && entry.bookId === bookId)
    );
    localStorage.setItem('issueHistory', JSON.stringify(updatedIssueHistory));
    addToActivityLog(`Book ID ${bookId} returned by Student ID ${studentId}. Fine: ₹${fine}`);

const messageBox = document.getElementById('messageBox');
    messageBox.classList.remove('d-none');

    setTimeout(() => {
      document.querySelector('form').reset();

      const today = new Date();
      document.getElementById('currentDate').value = formatDate(today);
      document.getElementById('returnDate').value = formatDate(today);
      let dueDate = new Date(today);
      dueDate.setDate(dueDate.getDate() + 15);
      document.getElementById('dueDate').value = formatDate(dueDate);
      document.getElementById('fine').value = '';
      document.getElementById('result').innerHTML = '';
      document.getElementById('bookSelector').innerHTML = `<option value="">-- Book issue--</option>`;
      messageBox.classList.add('d-none');

      //reload
      document.getElementById("studentId").dispatchEvent(new Event('change'));
    }, 1500);
  });

 //return data
  function IssuedTable() {
    const tableContainer = document.getElementById('returnTableContainer');
    const tableBody = document.getElementById('returnTableBody');
    tableBody.innerHTML = '';

    const returnHistory = JSON.parse(localStorage.getItem('returnHistory')) || [];

    returnHistory.forEach(entry => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${entry.studentId}</td>
        <td>${entry.bookId}</td>
        <td>${entry.studentName}</td>
        <td>${entry.bookTitle}</td>
        <td>${entry.issueDate}</td>
        <td>${entry.returnDate}</td>
        <td>${entry.dueDate}</td>
        <td>₹${entry.fine}</td>
      `;
      tableBody.appendChild(row);
    });

    tableContainer.style.display = tableContainer.style.display === 'none' ? 'block' : 'none';
  }
  function deleteRecord() {
  const selected = document.querySelector('input[name="selectedRecord"]:checked');
  if (!selected) {
    alert("Please select a record to delete.");
    return;
  }

  const index = parseInt(selected.value);
  if (!confirm("Are you sure you want to delete the selected record?")) return;

  let returnHistory = JSON.parse(localStorage.getItem('returnHistory')) || [];
  returnHistory.splice(index, 1);
  localStorage.setItem('returnHistory', JSON.stringify(returnHistory));

  toggleIssuedTable(); // Refresh table
}
function clearAllRecords() {
  if (!confirm("Are you sure you want to clear all return records? This action cannot be undone.")) {
    return;
  }

  // Remove returnHistory from localStorage
  localStorage.removeItem('returnHistory');

  // Clear table body display
  const tableBody = document.getElementById('returnTableBody');
  if (tableBody) {
    tableBody.innerHTML = '';
  }

  // Optionally hide the table container
  const tableContainer = document.getElementById('returnTableContainer');
  if (tableContainer) {
    tableContainer.style.display = 'none';
  }

  alert("All return records cleared successfully!");
}

function addToActivityLog(message) {
  const log = JSON.parse(localStorage.getItem("activityLog")) || [];
  log.unshift({ // add to start for recent-first
    timestamp: new Date().toLocaleString(),
    message
  });
  localStorage.setItem("activityLog", JSON.stringify(log));
}

</script>
<div id="messageBox" class="alert alert-success text-center d-none">Returned Successfully!</div>
</body>
</html>